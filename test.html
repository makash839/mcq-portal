<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MCQ Test</title>

<style>
body{
  font-family: Arial;
  background:#f2f2f2;
}
.box{
  background:#fff;
  max-width:800px;
  margin:30px auto;
  padding:20px;
  box-shadow:0 0 10px rgba(0,0,0,.2);
}
.option{
  display:block;
  margin:8px 0;
}
button{
  padding:8px 15px;
  margin:5px;
}
.correct{border-left:5px solid green;padding:10px}
.wrong{border-left:5px solid red;padding:10px}
.skipped{border-left:5px solid orange;padding:10px}
#timer{
  font-weight:bold;
  color:red;
}
</style>
</head>

<body>

<div class="box" id="quizBox">
  <h3 id="qno"></h3>
  <p id="question"></p>
  <div id="options"></div>

  <p>‚è± Time Left: <span id="timer">60</span> sec</p>

  <button onclick="nextQuestion()">Next</button>
  <button onclick="skipQuestion()">Skip</button>
  <button onclick="finalSubmit()">Final Submit</button>
</div>

<div class="box" id="resultBox" style="display:none"></div>

<script>
/* ================= AUTO VERSION SCRIPT LOADER ================= */
function loadScript(src, callback) {
  const s = document.createElement("script");
  s.src = src + "?v=" + Date.now();   // üî• auto cache bust
  s.onload = callback;
  document.head.appendChild(s);
}

/* ================= SUBJECT SELECT ================= */
const params = new URLSearchParams(window.location.search);
const subject = params.get("subject");

if(!subject){
  alert("Subject not selected");
}

/* ================= GLOBAL VARIABLES ================= */
let questions=[];
let index=0;
let answers=[];
let correct=0, wrong=0, skipped=0;

let timeLeft=60;
let timerInterval;
let startTestTime=Date.now();
let timePerQuestion=[];
let qStartTime=0;

/* ================= START TEST ================= */
function startTest(){
  if(subject==="history"){
    loadScript("data/history.js", ()=>{
      questions = historyQuestions;
      initTest();
    });
  }
  else if(subject==="polity"){
    loadScript("data/polity.js", ()=>{
      questions = polityQuestions;
      initTest();
    });
  }
  else if(subject==="geography"){
    loadScript("data/geography.js", ()=>{
      questions = geographyQuestions;
      initTest();
    });
  }
  else{
    alert("Invalid subject");
  }
}

/* ================= INIT ================= */
function initTest(){
  index=0;
  answers=[];
  correct=wrong=skipped=0;
  startTestTime=Date.now();
  loadQuestion();
}

/* ================= LOAD QUESTION ================= */
function loadQuestion(){
  clearInterval(timerInterval);

  timeLeft=60;
  document.getElementById("timer").innerText=timeLeft;

  const q=questions[index];
  document.getElementById("qno").innerText =
    `Question ${index+1}/${questions.length}`;
  document.getElementById("question").innerText = q.question;

  const optDiv=document.getElementById("options");
  optDiv.innerHTML="";

  q.options.forEach((opt,i)=>{
    optDiv.innerHTML += `
      <label class="option">
        <input type="radio" name="opt" value="${i}">
        ${opt}
      </label>`;
  });

  qStartTime = Date.now();

  timerInterval = setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").innerText=timeLeft;

    if(timeLeft<=0){
      clearInterval(timerInterval);
      answers[index]=null;
      timePerQuestion.push(60);
      index++;
      if(index<questions.length) loadQuestion();
      else finalSubmit();
    }
  },1000);
}

/* ================= NEXT ================= */
function nextQuestion(){
  clearInterval(timerInterval);

  const selected=document.querySelector("input[name='opt']:checked");
  const spent=Math.min(60,Math.round((Date.now()-qStartTime)/1000));
  timePerQuestion.push(spent);

  if(selected) answers[index]=parseInt(selected.value);
  else answers[index]=null;

  index++;
  if(index<questions.length) loadQuestion();
  else finalSubmit();
}

/* ================= SKIP ================= */
function skipQuestion(){
  clearInterval(timerInterval);
  answers[index]=null;
  timePerQuestion.push(60);
  index++;
  if(index<questions.length) loadQuestion();
  else finalSubmit();
}

/* ================= FINAL SUBMIT ================= */
function finalSubmit(){
  clearInterval(timerInterval);
  document.getElementById("quizBox").style.display="none";

  const resBox=document.getElementById("resultBox");
  resBox.style.display="block";

  const totalTime=Math.round((Date.now()-startTestTime)/1000);
  const avgTime=(totalTime/questions.length).toFixed(1);

  let reviewHTML="";

  questions.forEach((q,i)=>{
    const ua=answers[i];

    if(ua===null){
      skipped++;
      reviewHTML+=`
      <div class="skipped">
        <b>Q:</b> ${q.question}<br>
        <b>Status:</b> Skipped<br>
        <b>Correct:</b> ${q.options[q.correct]}<br>
        <b>Explanation:</b> ${q.explanation}
      </div>`;
    }
    else if(ua===q.correct){
      correct++;
      reviewHTML+=`
      <div class="correct">
        <b>Q:</b> ${q.question}<br>
        <b>Status:</b> Correct<br>
        <b>Explanation:</b> ${q.explanation}
      </div>`;
    }
    else{
      wrong++;
      reviewHTML+=`
      <div class="wrong">
        <b>Q:</b> ${q.question}<br>
        <b>Your:</b> ${q.options[ua]}<br>
        <b>Correct:</b> ${q.options[q.correct]}<br>
        <b>Explanation:</b> ${q.explanation}
      </div>`;
    }
  });

  resBox.innerHTML = `
    <h2>üìä Final Result</h2>
    <p><b>Total Questions:</b> ${questions.length}</p>
    <p><b>Correct:</b> ${correct}</p>
    <p><b>Wrong:</b> ${wrong}</p>
    <p><b>Skipped:</b> ${skipped}</p>
    <p><b>Total Time:</b> ${totalTime} sec</p>
    <p><b>Average Time / Question:</b> ${avgTime} sec</p>
    <hr>
    <h3>Answer Review</h3>
    ${reviewHTML}
  `;
}

/* ================= START ================= */
startTest();
</script>

</body>
</html>
